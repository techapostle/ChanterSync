Below is a **Tech Stack Specification** which is aimed at delivering the following:

* **Cross-platform PWA first** (iPad Safari & Android Chrome)  
* **Full-stack TypeScript** for speed of development and shared types  
* **Real-time fan-out** with sub-200 ms local-LAN latency  
* **PostgreSQL-centric state** (strong consistency, JSONB, RLS)  
* **Commodity AWS primitives** so we stay cloud-agnostic if we ever self-host

---

## 1.  Front-End (PWA)

| Concern | Library / Tool | Notes |
|---------|----------------|-------|
| Framework | **React 18** + **TypeScript 5** | Mature, PDF.js ecosystem, dev familiarity |
| Build | **Vite** + `@vite-pwa/plugin` | Fast HMR; plugin injects SW manifest & Workbox strategy |
| Routing | **React Router 6** | Simple nested routes (`/library`, `/setlists/:id`) |
| State | **Zustand** | Local, minimal boilerplate; persists to IndexedDB where needed |
| Data fetching | **TanStack Query** | Request de-dup, cache, optimistic updates |
| UI / Styling | **Tailwind CSS 3** | Rapid prototyping, good dark-mode story |
| PDF rendering | **pdfjs-dist 3.11** via `react-pdf` thin wrapper | Canvas render, progressive page load |
| Icons | **Heroicons** (outline/solid) | Pure SVG, tree-shakable |
| Form validation | **Zod** | Schemas shared with API ↔ eliminates double typing |
| Internationalisation (UI) | **i18next** | Only UI strings; PDFs remain as supplied |
| Offline | **Workbox** runtime caching (`CacheFirst` PDFs, `StaleWhileRevalidate` requests) |  ~7 MB AppShell + unlimited PDF cache (quota prompt) |

### Front-End Folder Structure _(src)_
```
core/
  api/
  hooks/
  store/
  types/
features/
  auth/
  library/
  setlist/
  service/
components/
  ui/
  pdf/
  layout/
pages/
public/
```

---

## 2.  API / Real-Time Layer

| Concern         | Choice                                              | Rationale                                                     |
| --------------- | --------------------------------------------------- | ------------------------------------------------------------- |
| Runtime         | **Node.js 20**                                      | Stable LTS, native fetch, top-level await                     |
| Framework       | **Fastify 4**                                       | Low overhead, built-in schema validation, plugin ecosystem    |
| Transport       | **WebSocket: ws** + **Socket.io Adapter (Redis)**   | Raw `ws` for gateway, but Socket.io semantics inside services |
| Protocol        | **JSON RPC 2.0-ish** (`{id,method,params}`) over WS | Single connection multiplexed per service                     |
| Data validation | **Zod** (shared)                                    | Compile-time & rung-time checks                               |
| Auth middleware | **fastify-jwt**                                     | Verifies HS256 tokens, attaches `req.user`                    |
| Rate-limit      | **fastify-rate-limit** (Redis)                      | Protect file upload & login endpoints                         |
| API Docs        | **OpenAPI 3** via `fastify-swagger`                 | Autogenerated, served at `/docs`                              |

> **Deployment model**  
> * `api-gateway` pod (stateless, exposes 443)  
> * `realtime-hub` pod (ws; horizontal scale with Redis adapter)  
> * Both behind AWS ALB (HTTP/2 + WebSocket pass-through)

---

## 3.  Core Application Service

| Concern | Choice | Notes |
|---------|--------|-------|
| Framework | **NestJS 10 (monorepo mode)** | Gives us CQRS modules, testing harness |
| Message Bus | **NATS JetStream** | Light, cloud-native, exactly-once for broadcasts & worker jobs |
| Cache / Lock | **Redis 7** | LeaderToken CAS (`SET key value NX PX 45000`) |
| PDF post-processing | **Go wasm-pdfcpu** in worker | Extract page count, fast thumbnail render |
| Background queue | **BullMQ** (Redis Streams) | Virus scan, CDN pre-warm |

---

## 4.  Persistence Layer

| Concern | Choice | Justification |
|---------|--------|---------------|
| Primary DB | **PostgreSQL 16 (AWS RDS Aurora Serverless v2)** | Elastic, JSONB for `state_json`, Row-Level Security|
| Migrations | **Prisma 5** | Schema as code; generates TS client |
| Object Store | **AWS S3** (`music-prod`) | Lifecycle → Glacier; S3 event to Lambda triggers virus scan |
| CDN | **AWS CloudFront** | Signed cookies/URL (1-week TTL) |
| Search | **PG Trigram** (`pg_trgm`) for file titles + tags | Avoid extra search appliance in MVP |

---

## 5.  Authentication & Sessions

| Concern | Choice |
|---------|--------|
| Account model | **Single Team secret** (env var) in v0.1; migrate to Supabase Auth or Cognito + Magic Link in v0.2 |
| Token | **JWT HS256** – 30 min expiry; refresh via silent `/sessions/refresh` |
| Device session store | **Redis** keyed by `deviceSessionId` → `teamId,profileType,exp` |
| CSRF | SameSite=Lax cookies for REST; WS uses JWT in `Sec-WebSocket-Protocol` |

---

## 6.  Dev & Ops Tooling

| Area | Tooling |
|------|---------|
| Repo | **GitHub** mono-repo (`frontend/`, `backend/`, `infra/`) |
| CI | **GitHub Actions** (`pnpm install`, `nx run-many`, Cypress e2e) |
| Container | **Docker** (multi-stage) – `node:20-slim` |
| Orchestration | **AWS EKS (Kubernetes 1.29)** via **Terraform Cloud** |
| Observability | **Grafana Cloud** (Prom, Loki), **Sentry** (front & back) |
| Feature flags | **ConfigCat** (UI sync toggle, future page-flip mode) |
| Secrets | **AWS Secrets Manager** + sealed-secrets K8s controller |
| Roll-back | **ArgoCD** GitOps; blue-green on API Gateway |

---

## 7.  Edge & Offline Details

* **Service Worker** generated by Workbox CLI:  
  * `runtimeCaching` for `/pdf/*` (`CacheFirst`, maxEntries 150, maxAge 30d)  
  * `navigateFallback` `/index.html`  
* **IndexedDB store** holds `pdfMeta`, `pageState`, last-used set list.  
* **Link prefetch**: `rel="prefetch"` for next PDF once hymn broadcast occurs.

---

## 8.  Interaction Cheat-Sheet (request–flow)

### 8.1 PDF Upload (Choirmaster)
```
[Client]  PUT /library-files (multipart; presigned S3 URL) ──► [S3]
          POST /library-files/commit {fileKey,meta} ──►  [Fastify]
            ↳ writes LibraryFiles row (Prisma)
            ↳ publishes NATS "libraryFile.created"

[Worker]  ⟵ subscribed → generates thumbnail → updates row → fires CDN warm job
```

### 8.2 Claim Leadership
```
[Device A] POST /service-instances/{id}/leader-heartbeat
           BODY {deviceSessionId, ts}

[Core]  SQL:
        UPDATE ServiceInstances
          SET leader_device_id = :deviceA,
              leader_updated_at = NOW()
        WHERE id = :serviceId
          AND (leader_device_id IS NULL
             OR leader_updated_at < NOW() - INTERVAL '45 sec');
```
Return 200 → client shows “Broadcasting”.

---

## 9.  Why this stack (pros/cons snapshot)

| Layer | Pros | Cons |
|-------|------|------|
| React + Vite PWA | Familiar, massive ecosystem, lightning dev cycle | Larger bundle than Svelte/Preact (solved with code-split) |
| Fastify Gateway | 50 k req/s, JSON schema validation | Less batteries-included than Nest; we compensate with plugins |
| NestJS core | Opinionated, DI, testing | Verbose decorators; mitigated by Nx monorepo generators |
| Postgres 16 | ACID; JSONB; RLS; trigram search | Need read replica if >200 rps on search endpoints |
| NATS JetStream | At-least-once & KV, ≤ 1 ms RTT | Ops overhead vs. SNS/SQS; we run as stateful set |
| AWS stack | Mature, predictable cost, PIPEDA region | Vendor lock; but infra is IaC so portable |

---

## 10.  Next Steps / Open Questions

1. **Magic-link provider:** roll custom SES templates or adopt Supabase Auth now?  
2. **Thumbnail service language:** stay in Go/wasm or switch to Rust `pdfium-render`?  
3. **Native shell roadmap:** Capacitor vs. Expo EAS build once v1.0 hits.

---

### TL;DR  
We commit to a **full-stack TypeScript, React PWA + Fastify/Nest + Postgres/S3** pipeline, layered on AWS primitives and Redis/NATS for real-time.  Everything is containerised, GitOps driven, horizontally scalable, and tuned for <200 ms broadcast latency on the same LAN.

This gives us **one language, one set of types, one source-of-truth**, and enough head-room to handle Pascha-sized spikes without sweat.